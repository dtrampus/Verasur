{% extends '::base.html.twig' %}

{% block content %}
    <div class="row">
        <div class="col-xs-12 col-sm-7 col-md-7 col-lg-4">
            <h1 class="page-title txt-color-blueDark"><i class="fa fa-desktop fa-fw "></i> Gestión de Pases <span>&gt; Crear Pase </span></h1>
        </div>
    </div>

    <div class="row">
        <article class="col-sm-12 col-md-12 col-lg-12">
            <!-- Widget ID (each widget will need unique ID)-->
            <div class="jarviswidget" id="wid-id-0" data-widget-colorbutton="false" data-widget-editbutton="false">
                <!-- widget options:
                usage: <div class="jarviswidget" id="wid-id-0" data-widget-editbutton="false">

                data-widget-colorbutton="false"
                data-widget-editbutton="false"
                data-widget-togglebutton="false"
                data-widget-deletebutton="false"
                data-widget-fullscreenbutton="false"
                data-widget-custombutton="false"
                data-widget-collapsed="true"
                data-widget-sortable="false"

                -->
                <header>
                    <span class="widget-icon"> <i class="fa fa-share-square-o"></i> </span>
                    <h2>Formulario de declaración de pase</h2>
                </header>

                <!-- widget div-->
                <div>
                    <!-- widget edit box -->
                    <div class="jarviswidget-editbox">
                        <!-- This area used as dropdown edit box -->
                    </div>
                    <!-- end widget edit box -->

                    <!-- widget content -->
                    <div class="widget-body">
                        <form name="mainbundle_pass" method="post" id="pass-form" action="/pass/create">
                            <div id="mainbundle_pass">
                                <div class='row'>
                                    <div class='col-md-12'>
                                        <div class="form-group">
                                            <label class="control-label required">Fecha</label>
                                            <div id="mainbundle_pass_date" class="form-inline">
                                                <input type="date" id="mainbundle_pass_date_date" name="date" required="required" class="form-control" />
                                                <input type="time" id="mainbundle_pass_date_time" name="time" required="required" class="form-control" />
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class='row'>
                                    <div class='col-md-6'>
                                        <div class="form-group">                
                                            <label class="control-label required" for="mainbundle_pass_tank_origin">Tanque/Planta Origen</label>
                                            <select id="mainbundle_pass_tank_origin" name="tank_1" required="required" class="select2 form-control" style="width:100%">
                                                <option value="" selected="selected">Elige una opción</option>    
                                                {% for tank in tanks %}
                                                    <option value="{{ tank.id }}" >{{ tank.code }} - {{ tank.description }}</option>                   
                                                {% endfor %}
                                            </select>
                                            <span id='cantidad1'></span>
                                        </div>
                                    </div>
                                    <div class='col-md-6'>
                                        <div class="form-group">                
                                            <label class="control-label required" for="mainbundle_pass_tank_destination">Tanque/Planta Destino</label>
                                            <select id="mainbundle_pass_tank_destination" name="tank_2" required="required" class="select2 form-control" style="width:100%">
                                                <option value="" selected="selected">Elige una opción</option>    
                                                {% for tank in tanks %}
                                                    <option value="{{ tank.id }}" >{{ tank.code }} - {{ tank.description }}</option>                   
                                                {% endfor %}
                                            </select>
                                            <span id='cantidad2'></span>
                                        </div>
                                    </div>
                                </div>
                                <div class='row'>
                                    <div class='col-md-6'>
                                        <div class="form-group">                
                                            <label class="control-label required" for="mainbundle_pass_product">Producto</label>
                                            <select id="mainbundle_pass_product" name="product" required="required" class="select2 form-control" style="width:100%">
                                                <option value="" selected="selected">Elige una opción</option>    
                                            </select>
                                        </div>
                                    </div>
                                    <div class='col-md-6'>
                                        <div class="form-group">                
                                            <label class="control-label required" for="mainbundle_pass_quantity">Cantidad</label>
                                            <input type="text" id="mainbundle_pass_quantity" name="quantity" required="required" class="form-control" />
                                        </div>
                                    </div>
                                </div>
                                <div class="form-group">                
                                    <label class="control-label required" for="mainbundle_pass_observation">Observaciones</label>
                                    <textarea id="mainbundle_pass_observation" name="observation" required="required" class="form-control" rows="3"></textarea>
                                </div>
                                <div class="form-group">
                                    <button type="submit" id="mainbundle_pass_submit" name="mainbundle_pass[submit]" class="btn-primary btn">Crear</button>
                                </div>
                                <input type="hidden" id="mainbundle_pass__token" name="mainbundle_pass[_token]" class="form-control" value="" />
                            </div>
                        </form>
                    </div>
                    <!-- end widget content -->

                </div>
                <!-- end widget div -->

            </div>
            <!-- end widget -->
        </article>
    </div>
{% endblock %}


{% block javascripts %}
    {{ parent() }}
    {% javascripts 'SmartAdmin/js/plugin/jquery-validate/jquery.validate.min.js'
    %}
    <script src="{{ asset_url }}" type="text/javascript"></script>
    {% endjavascripts %}

    <script type="text/javascript">
        // START AND FINISH DATE
        $(document).ready(function () {

            $("#mainbundle_pass_product").html("");
            $("#mainbundle_pass_tank_origin").change(function () {
                var value = $("#mainbundle_pass_tank_origin").select2('val');
                if (value != 0) {
                    $.ajax({
                        type: 'GET',
                        url: Routing.generate('getProductAjax', {id: value}),
                        dataType: "json",
                        success: function (jsonTanks) {
                            $('#mainbundle_pass_product').html("");
                            for (var tank in jsonTanks) {
                                var arrayTank = jsonTanks[tank];
                                $('#mainbundle_pass_product').append("<option value=" + arrayTank[0] + ">" + arrayTank[1] + " - " + arrayTank[2] + "</option>");
                            }
                        }
                    });
                } else {
                    $('#mainbundle_pass_product').html("");
                }
            });

            $("#mainbundle_pass_product").html("");
            $("#mainbundle_pass_tank_origin").change(function () {
                var value = $("#mainbundle_pass_tank_origin").select2('val');
                if (value != 0) {
                    $.ajax({
                        type: 'GET',
                        url: Routing.generate('calculateCapacity', {id: value}),
                        dataType: "json",
                        success: function (jsonTank) {
                            if (jsonTank['tankOcupedCapacity'] != null) {
                                $('#cantidad1').html("<span class='help-block'>Ocupado en el tanque: " + jsonTank['tankOcupedCapacity'] + "</span>");
                            } else {
                                $('#cantidad1').html("<span class='help-block'>Ocupado en el tanque: 0 </span>");
                            }
                        }
                    });
                }
            });

            $("#mainbundle_pass_product").html("");
            $("#mainbundle_pass_tank_destination").change(function () {
                var value = $("#mainbundle_pass_tank_destination").select2('val');
                if (value != 0) {
                    $.ajax({
                        type: 'GET',
                        url: Routing.generate('calculateCapacity', {id: value}),
                        dataType: "json",
                        success: function (jsonTank) {
                            $('#cantidad2').html("<span class='help-block'>Capacidad disponible en el tanque: " + jsonTank['tankFreeCapacity'] + "</span>");
                        }
                    });
                }
            });

            jQuery.validator.addMethod("notEqual", function (value, element, param) {
                return $('#mainbundle_pass_tank_origin').select2('val') != $('#mainbundle_pass_tank_destination').select2('val');
            }, "Los tanques son iguales");

            jQuery.validator.addMethod("maxOriginQuantity", function (value, element, param) {
                var valueT = parseInt($("#mainbundle_pass_tank_origin").select2('val'));
                var valueQ = parseFloat($("#mainbundle_pass_quantity").val());
                var response;
                if (valueT != 0) {
                    $.ajax({
                        type: 'GET',
                        url: Routing.generate('calculateCapacity', {id: valueT}),
                        dataType: "json",
                        async: false,
                        success: function (jsonTank) {
                            response = valueQ <= jsonTank['tankOcupedCapacity'];
                        }
                    });
                }
                return response;
            }, "La cantidad no puede superar a la del tanque de origen.");

            jQuery.validator.addMethod("maxDestinyQuantity", function (value, element, param) {
                var valueT2 = parseInt($("#mainbundle_pass_tank_destination").select2('val'));
                var valueQ2 = parseFloat($("#mainbundle_pass_quantity").val());
                var response;
                if (valueT2 != 0) {
                    $.ajax({
                        type: 'GET',
                        url: Routing.generate('calculateCapacity', {id: valueT2}),
                        dataType: "json",
                        async: false,
                        success: function (jsonTank) {
                            response = valueQ2 <= jsonTank['tankFreeCapacity'];
                        }
                    });
                }
                return response;
            }, "La cantidad no puede superar a la del tanque de destino.");

            jQuery.validator.addMethod("heigherThan0", function (value, element, param) {
                var quant = parseFloat($("#mainbundle_pass_quantity").val());
                var response = quant >= 0.01;
                return response;
            }, "La cantidad tiene que ser mayor a 0");

            $('#pass-form').validate({
                highlight: function (element) {
                    $(element).closest('.form-group').addClass('has-error');
                },
                unhighlight: function (element) {
                    $(element).closest('.form-group').removeClass('has-error');
                },
                errorElement: 'span',
                errorClass: 'help-block',
                errorPlacement: function (error, element) {
                    if (element.parent('.input-group').length) {
                        error.insertAfter(element.parent());
                    } else {
                        error.insertAfter(element);
                    }
                },
                rules: {
                    tank_1: {
                        required: true,
                        notEqual: true
                    },
                    quantity: {
                        required: true,
                        number: true,
                        maxOriginQuantity: true,
                        maxDestinyQuantity: true,
                        heigherThan0: true
                    },
                    tank_2: {
                        required: true,
                        notEqual: true
                    },
                    product: {
                        required: true
                    },
                    date: {
                        required: true
                    },
                    time: {
                        required: true
                    },
                    observation: {
                        required: false
                    }
                },
                messages: {
                    tank_1: {
                        required: "Este campo es requerido",
                        notEqual: "Los tanques no deben ser iguales"
                    },
                    quantity: {
                        required: "Este campo es requerido",
                        number: "El valor ingresado debe ser un número",
                        maxOriginQuantity: "La cantidad no puede superar a la del tanque de origen",
                        maxDestinyQuantity: "La cantidad no puede superar a la del tanque de destino",
                        heigherThan0: "La cantidad tiene que ser mayor que 0"
                    },
                    tank_2: {
                        required: "Este campo es requerido",
                        notEqual: "Los tanques no deben ser iguales"
                    },
                    product: {
                        required: "Este campo es requerido"
                    },
                    date: {
                        required: "Este campo es requerido"
                    },
                    time: {
                        required: ""
                    }
                }
            });
            $("select").removeClass("form-control").on("change", function (e) {
                $(this).valid();
            });
        });
    </script>
{% endblock %}
